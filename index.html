<html>

<body>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <div style="font-size:20px; padding:5px">
    <h1>Generate text mappings files</h1>
    <div style="display:flex">
      <div><input id="input" type="file" /></div>
      <div id="submitButton"></div>
    </div>
    <div style="padding:5px" id="fileLinks"></div>
    <div id="statusMessage"></div>
  </div>

  <script>

    function getUniqueArrayValues(arrayData) {
      return [...new Set(arrayData)]
    }

    function addLinkToPage(linkURL, linkText, downloadedFilename, pageDivId) {

      const link = document.createElement("a");

      const div = document.createElement("div");

      div.id = pageDivId

      link.href = linkURL

      link.text = linkText

      link.download = downloadedFilename

      document.getElementById("fileLinks").appendChild(div)

      document.getElementById(pageDivId).appendChild(link)

    }

    function createBlobURL(worksheetDataByRows, columns, suffix = {}) {

      var fileData = ""

      worksheetDataByRows.forEach(worksheetRow => {

        // We need to create a new object to hold the row data so we can ensure the
        // field names of the object are all lower case...

        var rowData = {}

        Object.keys(worksheetRow).forEach(fieldName => rowData[fieldName.toLowerCase()] = worksheetRow[fieldName])

        const rowValues = []
        
        columns.map(columnName => rowValues.push(rowData[columnName.toLowerCase()] 
          + (!!suffix[columnName] ? suffix[columnName] : "")))

        if (!(rowValues.includes("NA") || rowValues.includes("Derived") || rowValues.includes("")))
          fileData = fileData + rowValues.join("\t") + "\n"
      })

      var formBlob = new Blob([fileData], { type: 'text/plain' });

      const downloadLink = window.URL.createObjectURL(formBlob);

      return downloadLink

    }

    const inputElement = document.getElementById("input");
    
    inputElement.addEventListener("change", addConvertButton, false);

    function addConvertButton() {

      const fileList = this.files;
      
      const submitButtonDiv = document.getElementById("submitButton");
      
      const submitButtonObject = document.createElement("button");

      submitButtonObject.textContent = "Convert file"
        
      submitButtonObject.addEventListener("click", () => handleFiles(fileList), false);
      
      submitButtonDiv.innerHTML = ""
      
      document.getElementById("fileLinks").innerHTML = ""
      
      document.getElementById("statusMessage").textContent = ""
      
      submitButtonDiv.appendChild(submitButtonObject)
    
    }

    function handleFiles(fileList) {

      document.getElementById("fileLinks").innerHTML = ""

      const reader = new FileReader()

      reader.onload = (function (event) {

        const wb = XLSX.read(reader.result, { nullError: true });

        // Get QV and TV mappings worksheet...
        
        const qvTvWorksheet = wb['Sheets'][Object.keys(wb['Sheets'])[0]]

        const qvTvWorksheetOrderedByRows = XLSX.utils.sheet_to_json(qvTvWorksheet, { defval: "" });

        var datasetPrefixes = (getUniqueArrayValues(qvTvWorksheetOrderedByRows.map(
          worksheetRow => worksheetRow['Dataset prefix']).filter(datasetPrefixCell =>
            (!!datasetPrefixCell && !(datasetPrefixCell.includes("NA") 
            || datasetPrefixCell.includes("Derived") || !datasetPrefixCell))
        )))

        var questionnairePrefixes = (getUniqueArrayValues(qvTvWorksheetOrderedByRows.map(
          worksheetRow => worksheetRow['Questionnaire prefix']).filter(questionnairePrefixCell =>
            (!!questionnairePrefixCell && !(questionnairePrefixCell.includes("NA") 
            || questionnairePrefixCell.includes("Derived") || !questionnairePrefixCell))
        )))

        questionnairePrefixes.forEach(questionnairePrefix => {
          
          var qvLinkURL = createBlobURL(qvTvWorksheetOrderedByRows.filter(
            worksheetRow => worksheetRow['Questionnaire prefix'] == questionnairePrefix), 
              ['Questionnaire prefix', 'Question Name', 'Dataset prefix', 'Variable Name'],
              { 'Questionnaire prefix': '_ccs01' })

            addLinkToPage(qvLinkURL, 
            `${questionnairePrefix}_qv.txt`, 
            `${questionnairePrefix}_qv.txt`, 
            `qv${questionnairePrefix.replaceAll("_", "-")}`)
        
          })

        datasetPrefixes.forEach(datasetPrefix => {
          
          var tvLinkURL = createBlobURL(qvTvWorksheetOrderedByRows.filter(
            worksheetRow => worksheetRow['Dataset prefix'] == datasetPrefix), 
            ['Dataset prefix', 'Variable Name', 'Topic ID'])
          
          addLinkToPage(tvLinkURL, 
          `${datasetPrefix}_tv.txt`, 
          `${datasetPrefix}_tv.txt`, 
          `tv${datasetPrefix.replaceAll("_", "-")}`)
        
        })

        simplifiedData = []

        qvTvWorksheetOrderedByRows.forEach(worksheetRow => {
          if (worksheetRow['Question Name'].includes("$")) {
            indexOfDollarSign = worksheetRow['Question Name'].indexOf("$")
            worksheetRow['Question Name'] = (worksheetRow['Question Name'].slice(0, indexOfDollarSign))

          }
          if (simplifiedData.filter(dataRow => dataRow['Question Name'] == worksheetRow['Question Name']
            && dataRow['Topic ID'] == worksheetRow['Topic ID']).length == 0)
            simplifiedData.push(worksheetRow)
        })
        
        questionnairePrefixes.forEach(questionnairePrefix => {
          
          var tqLinkURL = createBlobURL(simplifiedData.filter(
            dataRow => dataRow['Questionnaire prefix'] == questionnairePrefix), 
            ['Questionnaire prefix', 'Question Name', 'Topic ID'],
            { 'Questionnaire prefix': '_ccs01' })
          
          addLinkToPage(tqLinkURL, 
            `${questionnairePrefix}_tq.txt`, 
            `${questionnairePrefix}_tq.txt`, 
            `tq${questionnairePrefix.replaceAll("_", "-")}`)
        }
      )

        // Get DV mappings worksheet...

        const dvWorksheet = wb['Sheets'][Object.keys(wb['Sheets'])[1]]

        const dvWorksheetOrderedByRows = XLSX.utils.sheet_to_json(dvWorksheet, { defval: "" });

        datasetPrefixes = (getUniqueArrayValues(dvWorksheetOrderedByRows.map(
          worksheetRow => worksheetRow['Dataset prefix']).filter(datasetPrefixCell =>
          (!!datasetPrefixCell 
          && !(datasetPrefixCell.includes("NA") || datasetPrefixCell.includes("Derived") || !datasetPrefixCell))
        )))

        datasetPrefixes.forEach(datasetPrefix => {
          var dvLinkURL = createBlobURL(dvWorksheetOrderedByRows.filter(
            worksheetRow => worksheetRow['Dataset prefix'] == datasetPrefix), ["Dataset prefix",
            "Derived Variable Name",
            "Dataset prefix",
            "Source Variable Name"
          ])
          addLinkToPage(dvLinkURL, 
          `${datasetPrefix}_dv.txt`, 
          `${datasetPrefix}_dv.txt`, 
          `dv${datasetPrefix.replaceAll("_", "-")}`)
        })

      })

      reader.readAsArrayBuffer(fileList[0])

    }

  </script>


</body>

</html>