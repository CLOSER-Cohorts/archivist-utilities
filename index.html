<html>
    <body>
        <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
        <div style="font-size:20px; padding:5px"><h1>Generate text mappings files</h1>
            <div style="display:flex">
              <div><input id="input" type="file"/></div>
              <div id="submitButton"></div>
            </div>
            <div style="padding:5px" id="qv2"></div>
            <div id="statusMessage"></div>
            </div>

            <script>

function getUniqueArrayValues(arrayData) {
  return [...new Set(arrayData)]
}

            function createColumn(indexOffset,dataCellField,suffix = "") {
              var questionLabels=[]
      const indexes2 = [...Array(numberOfVariables).keys().map(x => (x*8)+4)]
      
      indexes2.forEach(x => {
          const qvTxtColumn2 = worksheetCells[dataCells[x]]['h']  
          questionLabels.push(qvTxtColumn2)
        }
      )

            }  

            function addLinkToPage(linkURL, linkText, downloadedFilename, pageDivId) {

              console.log(pageDivId)

                const link = document.createElement("a");

                const div = document.createElement("div");

                div.id=pageDivId

                link.href=linkURL

                link.text=linkText

                link.download=downloadedFilename

                //document.getElementById("qv2").innerHTML=""

                document.getElementById("qv2").appendChild(div)

                document.getElementById(pageDivId).appendChild(link)

            }    

            function createBlobURL(data, columns, suffix = {}) {

              var fileData = ""
              
      data.forEach(x => {
        
        var newObject = {}
       
        Object.keys(x).forEach(fieldName => newObject[fieldName.toLowerCase()] = x[fieldName]) 
      

        const fileEntry = []
        columns.map(y => fileEntry.push(newObject[y.toLowerCase()] + (!!suffix[y] ? suffix[y] : "")))
        
        if (!(fileEntry.includes("NA") || fileEntry.includes("Derived") || fileEntry.includes("")))
        fileData = fileData + fileEntry.join("\t") +"\n"
      
    })

      var formBlob = new Blob([fileData], { type: 'text/plain' });

      const link2 = window.URL.createObjectURL(formBlob);

      return link2

            }

                const inputElement = document.getElementById("input");
                inputElement.addEventListener("change", addConvertButton, false);

                function addConvertButton() {
                  const submitButtonElement = document.getElementById("submitButton");
                  const submitButton = document.createElement("button");
                  submitButton.textContent = "Convert file"
                  const fileList = this.files; /* now you can work with the file list */
                  submitButton.addEventListener("click", () => handleFiles(fileList), false);
                  submitButtonElement.innerHTML=""
                  document.getElementById("qv2").innerHTML=""
             //     document.getElementById("tv").innerHTML=""
             //     document.getElementById("tq").innerHTML=""
             //     document.getElementById("dv").innerHTML=""
                  document.getElementById("statusMessage").textContent = ""
                  submitButtonElement.appendChild(submitButton)
                }

                function handleFiles(fileList) {
                  
                  const reader = new FileReader()

                  reader.onload = (function (event) {

          //          try {
                  const wb = XLSX.read(reader.result, {nullError:true});
                // Get QV and TV Mappings sheet...
                    const cellNames = Object.keys(wb['Sheets'][Object.keys(wb['Sheets'])[0]])
                    console.log(Object.keys(wb['Sheets'])[0])
                    console.log(Object.keys(wb['Sheets'])[1])
      const worksheetCells = wb['Sheets'][Object.keys(wb['Sheets'])[0]]
      console.log(wb['Sheets'])

      console.log(cellNames)
      
      const data = XLSX.utils.sheet_to_json((worksheetCells),{defval:""});
     
      console.log(data)
      var datasets=(getUniqueArrayValues(data.map(x => x['Dataset prefix']).filter(y=>
      (!!y && !(y.includes("NA") || y.includes("Derived") || !y))
      )))

      console.log(datasets)

      var qvLinkURL=createBlobURL(data, ['Questionnaire prefix', 'Question Name', 'Dataset prefix', 'Variable Name'],
        { 'Questionnaire prefix': '_ccs01'}
      )

      addLinkToPage(qvLinkURL, "qv.txt", "qv.txt", "qv")

      console.log(data)

      datasets.forEach( x => {
        console.log(x)
        
        var tvLinkURL=createBlobURL(data.filter(y => y['Dataset prefix']==x), ['Dataset prefix', 'Variable Name', 'Topic ID'])
        addLinkToPage(tvLinkURL, `${x}_tv.txt`, `${x}_tv.txt`, `tv${x.replaceAll("_","-")}`)
      })
      
      
     // var tvLinkURL=createBlobURL(data, ['Dataset prefix', 'Variable Name', 'Topic ID']) 
        
     // addLinkToPage(tvLinkURL, "tv.txt", "tv.txt", "tv")
        //}
     // )
      
      var tqLinkURL=createBlobURL(data, ['Questionnaire prefix', 'Question Name', 'Topic ID'])

      addLinkToPage(tqLinkURL, "tq.txt", "tq.txt", "tq")
// get DV worksheet
      const data2 = XLSX.utils.sheet_to_json((wb['Sheets'][Object.keys(wb['Sheets'])[1]]),{defval:""});
     
      
    //  NEED TO READ IN FROM DV SHEET NOW
     
    
    var dvLinkURL=createBlobURL(data2, ["Dataset prefix", 
    "Derived Variable Name", 
    "Dataset prefix",
    "Source Variable Name"
  ])

      addLinkToPage(dvLinkURL, "dv.txt", "dv.txt", "dv")
                  //  } catch(e) {document.getElementById("statusMessage").textContent = "Error parsing uploaded file. " + e}


     
        })
      
                  reader.readAsArrayBuffer(fileList[0])


                }
                            function generateFiles() {
                
                            }
                            </script>
                

    </body>
</html> 